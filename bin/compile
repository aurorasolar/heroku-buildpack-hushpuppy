#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -euo pipefail

# debug
# set -x

# clean up leaking environment
unset GIT_DIR

## parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BUILDPACK_DIR="$(dirname "$(dirname "$0")")"
BIN_DIR="$BUILD_DIR/bin"

# vendor directories
VENDORED_HUSHPUPPY="vendor/hushpuppy"
HUSHPUPPY_DIR="$BUILD_DIR/$VENDORED_HUSHPUPPY"
mkdir -p "$HUSHPUPPY_DIR"

# Update PATH
mkdir -p "$BIN_DIR"
PATH="$BIN_DIR:$PATH"

# For buildpacks, Heroku's config *ENV variable) are files with ENV_DIR.
export GITHUB_TOKEN=$(cat ${ENV_DIR}/GITHUB_TOKEN)

# Downloading and installing HushPuppy
curl -sL -u ${GITHUB_TOKEN} "https://api.github.com/repos/aurorasolar/hushpuppy/contents/cli/operations/install.sh?ref=master"|jq -r ".content"|base64 -d > $HUSHPUPPY_DIR/install.sh
chmod +x "$HUSHPUPPY_DIR/install.sh"
$HUSHPUPPY_DIR/install.sh -d $BIN_DIR

echo "-----> hushpuppy-buildpack: done"
